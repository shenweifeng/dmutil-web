<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.dianmic.dmutil.data.AlarmGxMapper">

	<insert id="saveAlarmGx" parameterType="AlarmGx"
	useGeneratedKeys="true" keyProperty="id">
		INSERT INTO `tb_dmalarm_alarm`
		(`yhbh`, `jqnr`, `bjsj`, `fqbh`, `bjxx`,
		`cuId`, `source`, `protocol`, `subsystem`,
		`jqnrNew`, `subsystemNew`)
		VALUES
		(#{yhbh}, #{jqnr}, #{bjsj}, #{fqbh}, #{bjxx},
		#{cuId}, #{source}, #{protocol}, #{subsystem},
		#{jqnrNew}, #{subsystemNew});
	</insert>
	
	<insert id="saveAlarmPic" parameterType="java.util.List">
		INSERT IGNORE INTO `tb_dmalarm_alarm_pic`
		( `alarmId`, `photo`, `cuId` )
		VALUES
		<foreach collection="list" item="item" index="index" separator="," open="" close="">
			( #{item.alarmId}, #{item.photo}, #{item.cuId} )
		</foreach>
	</insert>
	
	<insert id="saveAlarmSource" parameterType="AlarmSource"
	useGeneratedKeys="true" keyProperty="id">
		INSERT INTO `tb_dmalarm_alarm_source`
		(`yhbh`, `jqnr`, `bjsj`, `fqbh`, `bjxx`, `uptime`,
		`cuId`, `source`, `ip`, `protocol`, `subsystem`, `sbid`,
		`jqnrNew`, `subsystemNew`)
		VALUES
		(#{yhbh}, #{jqnr}, #{bjsj}, #{fqbh}, #{bjxx}, now(),
		#{cuId}, #{source}, #{ip}, #{protocol}, #{subsystem}, #{sbid},
		#{jqnrNew}, #{subsystemNew});
	</insert>

	<update id="callAlarmAutoDoing" parameterType="Integer">
		{call p_alarmAutoDoing(#{id})}
	</update>
	
	<insert id="saveOrUpdateCustomerStatus" parameterType="AlarmGx">
		INSERT INTO `tb_dmalarm_customer_status`
		( `cuId`, `yhbh`, `yhmc`, `jqnr`, `bjsj`, 
		`fqbh`, `bjxx`, `source`, `alarmUptime`, `alarmId`, 
		`uptime`)

		VALUES

		( #{cuId}, #{yhbh}, #{yhmc}, #{jqnr}, #{bjsj},
		  #{fqbh}, #{bjxx}, #{source}, #{alarmUptime}, #{alarmId}, 
		  now() )

		ON DUPLICATE KEY UPDATE
		
		<if test="yhbh != null">`yhbh`=#{yhbh}, </if>
		<if test="yhmc != null">`yhmc`=#{yhmc}, </if>
		<if test="jqnr != null">`jqnr`=#{jqnr}, </if>
		<if test="bjsj != null">`bjsj`=#{bjsj}, </if>
		
		<if test="fqbh != null">`fqbh`=#{fqbh}, </if>
		<if test="bjxx != null">`bjxx`=#{bjxx}, </if>
		<if test="source != null">`source`=#{source}, </if>
		<if test="alarmUptime != null">`alarmUptime`=#{alarmUptime}, </if>
		<if test="alarmId != null">`alarmId`=#{alarmId}, </if>
		
		`uptime` = now();
	</insert>
	
	<insert id="saveOrUpdateCustomerAlarm" parameterType="CustomerAlarm">
		INSERT INTO `tb_dmalarm_customer_alarm`
		( `cuId`, `alarmId`, `bjsj`, `bjnr`, `uptime`)
		VALUES
		( #{cuId}, #{alarmId}, #{bjsj}, #{bjnr}, now() )
		ON DUPLICATE KEY UPDATE
		<if test="alarmId != null">`alarmId`=#{alarmId}, </if>
		<if test="bjsj != null">`bjsj`=#{bjsj}, </if>
		<if test="bjnr != null">`bjnr`=#{bjnr}, </if>
		`uptime` = now();
	</insert>

	<insert id="saveAlarmOriginal" parameterType="AlarmOriginal"
	useGeneratedKeys="true" keyProperty="id">
		INSERT INTO `tb_dmalarm_alarm_original`
		(`p1`, `p2`, `ip`, `ctime`)
		VALUES
		(#{p1}, #{p2}, #{ip}, now());
	</insert>
	
	<select id="getCustomerSubsystem" parameterType="CustomerSubsystem"
	resultType="CustomerSubsystem">
	    select a.subsystemCode, a.subsystemName
		from `tb_dmalarm_customer_subsystem` a
		where a.`cuId`=#{cuId} and a.`subsystemCode`=#{subsystemCode}
		limit 1;
	</select>
	<select id="getCustomerSubsystemArea" parameterType="CustomerSubsystemArea"
	resultType="CustomerSubsystemArea">
	    select b.subsystemCode, b.subsystemName, a.areaName
		from `tb_dmalarm_customer_subsystem_area` a
		left join `tb_dmalarm_customer_subsystem` b on a.`subsystemId`=b.id
		where b.`cuId`=#{cuId} and a.`areaCode`=#{areaCode}
		limit 1;
	</select>
	
</mapper>